<?php  class acf_location { function __construct() { add_filter( 'acf/location/rule_match/post_type', array($this, 'rule_match_post_type'), 10, 3 ); add_filter( 'acf/location/rule_match/post', array($this, 'rule_match_post'), 10, 3 ); add_filter( 'acf/location/rule_match/post_category', array($this, 'rule_match_post_taxonomy'), 10, 3 ); add_filter( 'acf/location/rule_match/post_format', array($this, 'rule_match_post_format'), 10, 3 ); add_filter( 'acf/location/rule_match/post_status', array($this, 'rule_match_post_status'), 10, 3 ); add_filter( 'acf/location/rule_match/post_taxonomy', array($this, 'rule_match_post_taxonomy'), 10, 3 ); add_filter( 'acf/location/rule_match/page', array($this, 'rule_match_post'), 10, 3 ); add_filter( 'acf/location/rule_match/page_type', array($this, 'rule_match_page_type'), 10, 3 ); add_filter( 'acf/location/rule_match/page_parent', array($this, 'rule_match_page_parent'), 10, 3 ); add_filter( 'acf/location/rule_match/page_template', array($this, 'rule_match_page_template'), 10, 3 ); add_filter( 'acf/location/rule_match/current_user', array($this, 'rule_match_current_user'), 10, 3 ); add_filter( 'acf/location/rule_match/current_user_role', array($this, 'rule_match_current_user_role'), 10, 3 ); add_filter( 'acf/location/rule_match/user_form', array($this, 'rule_match_user_form'), 10, 3 ); add_filter( 'acf/location/rule_match/user_role', array($this, 'rule_match_user_role'), 10, 3 ); add_filter( 'acf/location/rule_match/taxonomy', array($this, 'rule_match_taxonomy'), 10, 3 ); add_filter( 'acf/location/rule_match/attachment', array($this, 'rule_match_attachment'), 10, 3 ); add_filter( 'acf/location/rule_match/comment', array($this, 'rule_match_comment'), 10, 3 ); add_filter( 'acf/location/rule_match/widget', array($this, 'rule_match_widget'), 10, 3 ); } function rule_match_post_type( $match, $rule, $options ) { $post_type = $options['post_type']; if( !$post_type ) { if( !$options['post_id'] ) { return false; } $post_type = get_post_type( $options['post_id'] ); } if( $rule['operator'] == "==" ) { $match = ( $post_type === $rule['value'] ); } elseif( $rule['operator'] == "!=" ) { $match = ( $post_type !== $rule['value'] ); } return $match; } function rule_match_current_user( $match, $rule, $options ) { if( $rule['value'] == 'logged_in' ) { if( $rule['operator'] == "==" ) { $match = is_user_logged_in(); } elseif( $rule['operator'] == "!=" ) { $match = !is_user_logged_in(); } return $match; } if( $rule['value'] == 'viewing_front' ) { if( $rule['operator'] == "==" ) { $match = !is_admin(); } elseif( $rule['operator'] == "!=" ) { $match = is_admin(); } return $match; } if( $rule['value'] == 'viewing_back' ) { if( $rule['operator'] == "==" ) { $match = is_admin(); } elseif( $rule['operator'] == "!=" ) { $match = !is_admin(); } return $match; } return $match; } function rule_match_current_user_role( $match, $rule, $options ) { if( !is_user_logged_in() ) { return false; } $user = wp_get_current_user(); if( $rule['operator'] == "==" ) { if( $rule['value'] == 'super_admin' ) { $match = is_super_admin( $user->ID ); } else { $match = in_array( $rule['value'], $user->roles ); } } elseif( $rule['operator'] == "!=" ) { if( $rule['value'] == 'super_admin' ) { $match = !is_super_admin( $user->ID ); } else { $match = ( ! in_array( $rule['value'], $user->roles ) ); } } return $match; } function rule_match_post( $match, $rule, $options ) { $post_id = $options['post_id']; if( !$post_id ) { return false; } if( $rule['operator'] == "==") { $match = ( $options['post_id'] == $rule['value'] ); } elseif( $rule['operator'] == "!=") { $match = ( $options['post_id'] != $rule['value'] ); } return $match; } function rule_match_post_taxonomy( $match, $rule, $options ) { if( !$options['post_id'] ) { return false; } $terms = $options['post_taxonomy']; $data = acf_decode_taxonomy_term( $rule['value'] ); $term = get_term_by( 'slug', $data['term'], $data['taxonomy'] ); if( !$term && is_numeric($data['term']) ) { $term = get_term_by( 'id', $data['term'], $data['taxonomy'] ); } if( !$term ) { return false; } if( !$options['post_type'] ) { $options['post_type'] = get_post_type( $options['post_id'] ); } if( !$options['ajax'] ) { $terms = wp_get_post_terms( $options['post_id'], $term->taxonomy, array('fields' => 'ids') ); } if( empty($terms) ) { if( is_object_in_taxonomy($options['post_type'], 'category') ) { $terms = array( 1 ); } } if( $rule['operator'] == "==") { $match = in_array($term->term_id, $terms); } elseif( $rule['operator'] == "!=") { $match = !in_array($term->term_id, $terms); } return $match; } function rule_match_post_format( $match, $rule, $options ) { $post_format = $options['post_format']; if( !$post_format ) { if( !$options['post_id'] ) { return false; } if( !$options['post_type'] ) { $options['post_type'] = get_post_type( $options['post_id'] ); } if( post_type_supports( $options['post_type'], 'post-formats' ) ) { $post_format = get_post_format( $options['post_id'] ); if( $post_format === false ) { $post_format = 'standard'; } } } if( $rule['operator'] == "==") { $match = ( $post_format === $rule['value'] ); } elseif( $rule['operator'] == "!=") { $match = ( $post_format !== $rule['value'] ); } return $match; } function rule_match_post_status( $match, $rule, $options ) { if( !$options['post_id'] ) { return false; } $post_status = get_post_status( $options['post_id'] ); if( $post_status == 'auto-draft' ) { $post_status = 'draft'; } if( $rule['operator'] == "==") { $match = ( $post_status === $rule['value'] ); } elseif( $rule['operator'] == "!=") { $match = ( $post_status !== $rule['value'] ); } return $match; } function rule_match_page_type( $match, $rule, $options ) { if( !$options['post_id'] ) { return false; } $post = get_post( $options['post_id'] ); if( $rule['value'] == 'front_page') { $front_page = (int) get_option('page_on_front'); if( $rule['operator'] == "==" ) { $match = ( $front_page == $post->ID ); } elseif( $rule['operator'] == "!=" ) { $match = ( $front_page != $post->ID ); } } elseif( $rule['value'] == 'posts_page') { $posts_page = (int) get_option('page_for_posts'); if( $rule['operator'] == "==" ) { $match = ( $posts_page == $post->ID ); } elseif( $rule['operator'] == "!=" ) { $match = ( $posts_page != $post->ID ); } } elseif( $rule['value'] == 'top_level') { $post_parent = $post->post_parent; if( $options['page_parent'] ) { $post_parent = $options['page_parent']; } if( $rule['operator'] == "==" ) { $match = ( $post_parent == 0 ); } elseif( $rule['operator'] == "!=" ) { $match = ( $post_parent != 0 ); } } elseif( $rule['value'] == 'parent' ) { $children = get_pages(array( 'post_type' => $post->post_type, 'child_of' => $post->ID, )); if( $rule['operator'] == "==" ) { $match = ( count($children) > 0 ); } elseif( $rule['operator'] == "!=" ) { $match = ( count($children) == 0 ); } } elseif( $rule['value'] == 'child') { $post_parent = $post->post_parent; if( $options['page_parent'] ) { $post_parent = $options['page_parent']; } if( $rule['operator'] == "==" ) { $match = ( $post_parent != 0 ); } elseif( $rule['operator'] == "!=" ) { $match = ( $post_parent == 0 ); } } return $match; } function rule_match_page_parent( $match, $rule, $options ) { if( !$options['post_id'] ) { return false; } $post = get_post( $options['post_id'] ); $post_parent = $post->post_parent; if( $options['page_parent'] ) { $post_parent = $options['page_parent']; } if( $rule['operator'] == "==" ) { $match = ( $post_parent == $rule['value'] ); } elseif( $rule['operator'] == "!=" ) { $match = ( $post_parent != $rule['value'] ); } return $match; } function rule_match_page_template( $match, $rule, $options ) { $page_template = $options['page_template']; if( !$page_template && $options['post_id'] ) { $page_template = get_post_meta( $options['post_id'], '_wp_page_template', true ); } if( ! $page_template ) { $post_type = $options['post_type']; if( !$post_type && $options['post_id'] ) { $post_type = get_post_type( $options['post_id'] ); } if( $post_type === 'page' ) { $page_template = "default"; } } if( $rule['operator'] == "==" ) { $match = ( $page_template === $rule['value'] ); } elseif( $rule['operator'] == "!=" ) { $match = ( $page_template !== $rule['value'] ); } return $match; } function rule_match_user_form( $match, $rule, $options ) { $user_form = $options['user_form']; if( $user_form === 'add' ) { $user_form = 'edit'; } if( $user_form ) { if( $rule['operator'] == "==" ) { $match = ( $user_form == $rule['value'] ); if( $rule['value'] === 'all' ) { $match = true; } } elseif( $rule['operator'] == "!=" ) { $match = ( $user_form != $rule['value'] ); if( $rule['value'] === 'all' ) { $match = false; } } } return $match; } function rule_match_user_role( $match, $rule, $options ) { $user_id = $options['user_id']; $user_role = $options['user_role']; if( $user_role ) { if( $rule['operator'] == "==" ) { if( $user_role === $rule['value'] ) { $match = true; } if( $rule['value'] === 'all' ) { $match = true; } } elseif( $rule['operator'] == "!=" ) { if( $user_role !== $rule['value'] ) { $match = true; } if( $rule['value'] === 'all' ) { $match = false; } } } elseif( $user_id ) { if( $rule['operator'] == "==" ) { if( $user_id === 'new' ) { $match = ( $rule['value'] == get_option('default_role') ); } else { $match = ( user_can($user_id, $rule['value']) ); } if( $rule['value'] === 'all' ) { $match = true; } } elseif( $rule['operator'] == "!=" ) { if( $user_id === 'new' ) { $match = ( $rule['value'] != get_option('default_role') ); } else { $match = ( !user_can($user_id, $rule['value']) ); } if( $rule['value'] === 'all' ) { $match = false; } } } return $match; } function rule_match_taxonomy( $match, $rule, $options ) { $taxonomy = $options['taxonomy']; if( !$taxonomy ) { return false; } if( $rule['operator'] == "==" ) { $match = ( $taxonomy == $rule['value'] ); if( $rule['value'] == "all" ) { $match = true; } } elseif( $rule['operator'] == "!=" ) { $match = ( $taxonomy != $rule['value'] ); if( $rule['value'] == "all" ) { $match = false; } } return $match; } function rule_match_attachment( $match, $rule, $options ) { $attachment = $options['attachment']; if( ! $attachment ) { return false; } if( $rule['operator'] == "==" ) { $match = ( $attachment == $rule['value'] ); if( $rule['value'] == "all" ) { $match = true; } } elseif( $rule['operator'] == "!=" ) { $match = ( $attachment != $rule['value'] ); if( $rule['value'] == "all" ) { $match = false; } } return $match; } function rule_match_comment( $match, $rule, $options ) { $comment = $options['comment']; if( ! $comment ) { return false; } if( $rule['operator'] == "==" ) { $match = ( $comment == $rule['value'] ); if( $rule['value'] == "all" ) { $match = true; } } elseif( $rule['operator'] == "!=" ) { $match = ( $comment != $rule['value'] ); if( $rule['value'] == "all" ) { $match = false; } } return $match; } function rule_match_widget( $match, $rule, $options ) { $widget = $options['widget']; if( ! $widget ) { return false; } if( $rule['operator'] == "==" ) { $match = ( $widget == $rule['value'] ); if( $rule['value'] == "all" ) { $match = true; } } elseif( $rule['operator'] == "!=" ) { $match = ( $widget != $rule['value'] ); if( $rule['value'] == "all" ) { $match = false; } } return $match; } } new acf_location(); function acf_get_field_group_visibility( $field_group, $args = array() ) { $args = acf_parse_args($args, array( 'post_id' => 0, 'post_type' => 0, 'page_template' => 0, 'page_parent' => 0, 'page_type' => 0, 'post_category' => array(), 'post_format' => 0, 'post_taxonomy' => array(), 'taxonomy' => 0, 'user_id' => 0, 'user_role' => 0, 'user_form' => 0, 'attachment' => 0, 'comment' => 0, 'widget' => 0, 'lang' => 0, 'ajax' => false )); if( !$field_group['active'] ) { return false; } if( defined('ICL_LANGUAGE_CODE') ) { $args['lang'] = ICL_LANGUAGE_CODE; } $visibility = false; foreach( $field_group['location'] as $group_id => $group ) { $match_group = true; if( !empty($group) ) { foreach( $group as $rule_id => $rule ) { $match = apply_filters( 'acf/location/rule_match/' . $rule['param'] , false, $rule, $args ); if( !$match ) { $match_group = false; break; } } } if( $match_group ) { $visibility = true; } } return $visibility; } ?>

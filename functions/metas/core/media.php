<?php  class acf_media { function __construct() { add_action('acf/save_post', array($this, 'save_files'), 5, 1); add_action('acf/input/admin_footer_js', array($this, 'admin_footer_js')); add_filter('wp_handle_upload_prefilter', array($this, 'handle_upload_prefilter'), 10, 1); add_action( 'wp_ajax_query-attachments', array($this, 'wp_ajax_query_attachments'), -1); } function handle_upload_prefilter( $file ) { if( empty($_POST['_acfuploader']) ) { return $file; } $field = acf_get_field( $_POST['_acfuploader'] ); if( !$field ) { return $file; } $errors = acf_validate_attachment( $file, $field, 'upload' ); $errors = apply_filters("acf/upload_prefilter", $errors, $file, $field); $errors = apply_filters("acf/upload_prefilter/type={$field['type']}", $errors, $file, $field ); $errors = apply_filters("acf/upload_prefilter/name={$field['name']}", $errors, $file, $field ); $errors = apply_filters("acf/upload_prefilter/key={$field['key']}", $errors, $file, $field ); if( !empty($errors) ) { $file['error'] = implode("\n", $errors); } return $file; } function save_files( $post_id = 0 ) { if( empty($_FILES['acf']['name']) ) { return; } acf_upload_files(); } function admin_footer_js() { ?>acf.media.mime_types = <?php echo json_encode( get_allowed_mime_types() ); ?>;
	<?php
 } function wp_ajax_query_attachments() { add_filter('wp_prepare_attachment_for_js', array($this, 'wp_prepare_attachment_for_js'), 10, 3); } function wp_prepare_attachment_for_js( $response, $attachment, $meta ) { $response['acf_errors'] = false; if( empty($_POST['query']['_acfuploader']) ) { return $response; } $field = acf_get_field( $_POST['query']['_acfuploader'] ); if( !$field ) { return $response; } $errors = acf_validate_attachment( $response, $field, 'prepare' ); if( !empty($errors) ) { $response['acf_errors'] = implode('<br />', $errors); } return $response; } } new acf_media(); ?>

<?php  class acf_json { function __construct() { acf_update_setting('save_json', get_stylesheet_directory() . '/acf-json'); acf_append_setting('load_json', get_stylesheet_directory() . '/acf-json'); add_action('acf/update_field_group', array($this, 'update_field_group'), 10, 5); add_action('acf/duplicate_field_group', array($this, 'update_field_group'), 10, 5); add_action('acf/untrash_field_group', array($this, 'update_field_group'), 10, 5); add_action('acf/trash_field_group', array($this, 'delete_field_group'), 10, 5); add_action('acf/delete_field_group', array($this, 'delete_field_group'), 10, 5); add_action('acf/include_fields', array($this, 'include_fields'), 10, 5); } function update_field_group( $field_group ) { if( !acf_get_setting('json') ) { return; } $field_group['fields'] = acf_get_fields( $field_group ); acf_write_json_field_group( $field_group ); } function delete_field_group( $field_group ) { if( !acf_get_setting('json') ) { return; } acf_delete_json_field_group( $field_group['key'] ); } function include_fields() { if( !acf_get_setting('json') ) { return; } $paths = acf_get_setting('load_json'); foreach( $paths as $path ) { $path = untrailingslashit( $path ); if( !file_exists( $path ) ) { continue; } $dir = opendir( $path ); while(false !== ( $file = readdir($dir)) ) { if( strpos($file, '.json') === false ) { continue; } $json = file_get_contents("{$path}/{$file}"); if( empty($json) ) { continue; } $json = json_decode($json, true); $json['local'] = 'json'; acf_add_local_field_group( $json ); } } } } new acf_json(); function acf_write_json_field_group( $field_group ) { $path = acf_get_setting('save_json'); $file = $field_group['key'] . '.json'; $path = untrailingslashit( $path ); if( !is_writable($path) ) { return false; } $id = acf_extract_var( $field_group, 'ID' ); $field_group['modified'] = get_post_modified_time('U', true, $id, true); $field_group['fields'] = acf_prepare_fields_for_export( $field_group['fields'] ); $f = fopen("{$path}/{$file}", 'w'); fwrite($f, acf_json_encode( $field_group )); fclose($f); return true; } function acf_delete_json_field_group( $key ) { $path = acf_get_setting('save_json'); $file = $key . '.json'; $path = untrailingslashit( $path ); if( !is_readable("{$path}/{$file}") ) { return false; } unlink("{$path}/{$file}"); return true; } ?>

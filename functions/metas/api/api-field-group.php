<?php  function acf_is_field_group_key( $key = '' ) { if( is_string($key) && substr($key, 0, 6) === 'group_' ) { return true; } if( acf_is_local_field_group($key) ) { return true; } return false; } function acf_get_valid_field_group_key( $key = '' ) { if( !acf_is_field_group_key($key) ) { if( !$key ) { $key = uniqid(); } $key = "group_{$key}"; } return $key; } function acf_get_valid_field_group( $field_group = false ) { $field_group = acf_parse_args( $field_group, array( 'ID' => 0, 'key' => '', 'title' => '', 'fields' => array(), 'location' => array(), 'menu_order' => 0, 'position' => 'normal', 'style' => 'default', 'label_placement' => 'top', 'instruction_placement' => 'label', 'hide_on_screen' => array(), 'active' => 1, 'description' => '' )); $field_group = apply_filters('acf/get_valid_field_group', $field_group); return $field_group; } function acf_get_field_groups( $args = false ) { $field_groups = array(); $found = false; $cache = wp_cache_get( 'get_field_groups', 'acf', false, $found ); if( $found ) { return acf_filter_field_groups( $cache, $args ); } $posts = get_posts(array( 'post_type' => 'acf-field-group', 'posts_per_page' => -1, 'orderby' => 'menu_order title', 'order' => 'asc', 'suppress_filters' => false, 'post_status' => array('publish', 'acf-disabled'), 'update_post_meta_cache' => false )); if( $posts ) { foreach( $posts as $post ) { $field_groups[] = acf_get_field_group( $post ); } } $field_groups = apply_filters('acf/get_field_groups', $field_groups); wp_cache_set( 'get_field_groups', $field_groups, 'acf' ); return acf_filter_field_groups( $field_groups, $args ); } function acf_filter_field_groups( $field_groups, $args = false ) { if( empty($args) || empty($field_groups) ) { return $field_groups; } $keys = array_keys( $field_groups ); foreach( $keys as $key ) { $visibility = acf_get_field_group_visibility( $field_groups[ $key ], $args ); if( !$visibility ) { unset($field_groups[ $key ]); } } $field_groups = array_values( $field_groups ); return $field_groups; } function acf_get_field_group( $selector = false ) { $field_group = false; $k = 'ID'; $v = 0; if( is_numeric($selector) ) { $v = $selector; } elseif( is_string($selector) ) { $k = 'key'; $v = $selector; } elseif( is_object($selector) ) { $v = $selector->ID; } else { return false; } $cache_key = "get_field_group/{$k}={$v}"; $found = false; $cache = wp_cache_get( $cache_key, 'acf', false, $found ); if( $found ) { return $cache; } if( $k == 'ID' ) { $field_group = _acf_get_field_group_by_id( $v ); } else { $field_group = _acf_get_field_group_by_key( $v ); } $field_group = apply_filters('acf/get_field_group', $field_group); wp_cache_set( $cache_key, $field_group, 'acf' ); return $field_group; } function _acf_get_field_group_by_id( $post_id = 0 ) { $post = get_post( $post_id ); if( empty($post) || $post->post_type != 'acf-field-group' ) { return false; } if( $post->post_status == 'auto-draft' ) { $post->post_status = 'publish'; } $field_group = maybe_unserialize( $post->post_content ); $field_group['ID'] = $post->ID; $field_group['title'] = $post->post_title; $field_group['key'] = $post->post_name; $field_group['menu_order'] = $post->menu_order; $field_group['active'] = ($post->post_status === 'publish') ? 1 : 0; if( acf_is_local_field_group( $field_group['key'] ) ) { $field_group = acf_get_local_field_group( $field_group['key'] ); $field_group['ID'] = $post->ID; } $field_group = acf_get_valid_field_group( $field_group ); return $field_group; } function _acf_get_field_group_by_key( $key = '' ) { $field_group = false; if( acf_is_local_field_group( $key ) ) { $field_group = acf_get_local_field_group( $key ); $field_group = acf_get_valid_field_group( $field_group ); return $field_group; } $args = array( 'posts_per_page' => 1, 'post_type' => 'acf-field-group', 'orderby' => 'menu_order title', 'order' => 'ASC', 'suppress_filters' => false, 'post_status' => array('publish', 'acf-disabled', 'trash'), 'acf_group_key' => $key ); $posts = get_posts( $args ); if( empty($posts[0]) ) { return $field_group; } $field_group = _acf_get_field_group_by_id( $posts[0]->ID ); return $field_group; } function acf_update_field_group( $field_group = array() ) { $field_group = acf_get_valid_field_group( $field_group ); $field_group = wp_unslash( $field_group ); $field_group['location'] = array_values( $field_group['location'] ); foreach( $field_group['location'] as $k => $v ) { $field_group['location'][ $k ] = array_values( $v ); } $data = $field_group; $extract = acf_extract_vars($data, array( 'ID', 'key', 'title', 'menu_order', 'fields', 'active' )); $data = maybe_serialize( $data ); $post_status = $extract['active'] ? 'publish' : 'acf-disabled'; $save = array( 'ID' => $extract['ID'], 'post_status' => $post_status, 'post_type' => 'acf-field-group', 'post_title' => $extract['title'], 'post_name' => $extract['key'], 'post_excerpt' => sanitize_title($extract['title']), 'post_content' => $data, 'menu_order' => $extract['menu_order'], ); add_filter( 'wp_unique_post_slug', 'acf_update_field_group_wp_unique_post_slug', 100, 6 ); if( $field_group['ID'] ) { wp_update_post( $save ); } else { $field_group['ID'] = wp_insert_post( $save ); } do_action('acf/update_field_group', $field_group); wp_cache_delete("get_field_group/ID={$field_group['ID']}", 'acf'); wp_cache_delete("get_field_group/key={$field_group['key']}", 'acf'); wp_cache_delete("get_field_groups", 'acf'); return $field_group; } function acf_update_field_group_wp_unique_post_slug( $slug, $post_ID, $post_status, $post_type, $post_parent, $original_slug ) { if( $post_type == 'acf-field-group' ) { $slug = $original_slug; } return $slug; } function acf_duplicate_field_group( $selector = 0, $new_post_id = 0 ) { acf_disable_local(); $field_group = acf_get_field_group( $selector ); if( empty($field_group) ) { return false; } $orig_field_group = $field_group; $field_group['ID'] = $new_post_id; $field_group['key'] = uniqid('group_'); if( !$new_post_id ) { $field_group['title'] .= ' (' . __("copy", 'acf') . ')'; } $field_group = acf_update_field_group( $field_group ); $fields = acf_get_fields( $orig_field_group ); acf_duplicate_fields( $fields, $field_group['ID'] ); do_action('acf/duplicate_field_group', $field_group); return $field_group; } function acf_get_field_count( $field_group ) { $count = 0; if( !$field_group['ID'] ) { $count = acf_count_local_fields( $field_group['key'] ); } else { $posts = get_posts(array( 'posts_per_page' => -1, 'post_type' => 'acf-field', 'orderby' => 'menu_order', 'order' => 'ASC', 'suppress_filters' => true, 'post_parent' => $field_group['ID'], 'fields' => 'ids', 'post_status' => 'publish, trash' )); $count = count($posts); } $count = apply_filters('acf/get_field_count', $count, $field_group); return $count; } function acf_delete_field_group( $selector = 0 ) { acf_disable_local(); $field_group = acf_get_field_group( $selector ); if( empty($field_group) ) { return false; } $fields = acf_get_fields($field_group); if( !empty($fields) ) { foreach( $fields as $field ) { acf_delete_field( $field['ID'] ); } } wp_delete_post( $field_group['ID'] ); do_action('acf/delete_field_group', $field_group); return true; } function acf_trash_field_group( $selector = 0 ) { acf_disable_local(); $field_group = acf_get_field_group( $selector ); if( empty($field_group) ) { return false; } $fields = acf_get_fields($field_group); if( !empty($fields) ) { foreach( $fields as $field ) { acf_trash_field( $field['ID'] ); } } wp_trash_post( $field_group['ID'] ); do_action('acf/trash_field_group', $field_group); return true; } function acf_untrash_field_group( $selector = 0 ) { acf_disable_local(); $field_group = acf_get_field_group( $selector ); if( empty($field_group) ) { return false; } $fields = acf_get_fields($field_group); if( !empty($fields) ) { foreach( $fields as $field ) { acf_untrash_field( $field['ID'] ); } } wp_untrash_post( $field_group['ID'] ); do_action('acf/untrash_field_group', $field_group); return true; } function acf_get_field_group_style( $field_group ) { $e = ''; if( !is_array($field_group['hide_on_screen']) ) { return $e; } if( in_array('permalink',$field_group['hide_on_screen']) ) { $e .= '#edit-slug-box {display: none;} '; } if( in_array('the_content',$field_group['hide_on_screen']) ) { $e .= '#postdivrich {display: none;} '; } if( in_array('excerpt',$field_group['hide_on_screen']) ) { $e .= '#postexcerpt, #screen-meta label[for=postexcerpt-hide] {display: none;} '; } if( in_array('custom_fields',$field_group['hide_on_screen']) ) { $e .= '#postcustom, #screen-meta label[for=postcustom-hide] { display: none; } '; } if( in_array('discussion',$field_group['hide_on_screen']) ) { $e .= '#commentstatusdiv, #screen-meta label[for=commentstatusdiv-hide] {display: none;} '; } if( in_array('comments',$field_group['hide_on_screen']) ) { $e .= '#commentsdiv, #screen-meta label[for=commentsdiv-hide] {display: none;} '; } if( in_array('slug',$field_group['hide_on_screen']) ) { $e .= '#slugdiv, #screen-meta label[for=slugdiv-hide] {display: none;} '; } if( in_array('author',$field_group['hide_on_screen']) ) { $e .= '#authordiv, #screen-meta label[for=authordiv-hide] {display: none;} '; } if( in_array('format',$field_group['hide_on_screen']) ) { $e .= '#formatdiv, #screen-meta label[for=formatdiv-hide] {display: none;} '; } if( in_array('page_attributes',$field_group['hide_on_screen']) ) { $e .= '#pageparentdiv {display: none;} '; } if( in_array('featured_image',$field_group['hide_on_screen']) ) { $e .= '#postimagediv, #screen-meta label[for=postimagediv-hide] {display: none;} '; } if( in_array('revisions',$field_group['hide_on_screen']) ) { $e .= '#revisionsdiv, #screen-meta label[for=revisionsdiv-hide] {display: none;} '; } if( in_array('categories',$field_group['hide_on_screen']) ) { $e .= '#categorydiv, #screen-meta label[for=categorydiv-hide] {display: none;} '; } if( in_array('tags',$field_group['hide_on_screen']) ) { $e .= '#tagsdiv-post_tag, #screen-meta label[for=tagsdiv-post_tag-hide] {display: none;} '; } if( in_array('send-trackbacks',$field_group['hide_on_screen']) ) { $e .= '#trackbacksdiv, #screen-meta label[for=trackbacksdiv-hide] {display: none;} '; } return apply_filters('acf/get_field_group_style', $e, $field_group); } function acf_import_field_group( $field_group ) { $ref = array(); $order = array(); $fields = acf_extract_var($field_group, 'fields'); $fields = acf_prepare_fields_for_import( $fields ); if( $field_group['ID'] ) { acf_disable_local(); $db_fields = acf_get_fields_by_id( $field_group['ID'] ); $db_fields = acf_prepare_fields_for_import( $db_fields ); $keys = array(); foreach( $fields as $field ) { $keys[] = $field['key']; } foreach( $db_fields as $field ) { $ref[ $field['key'] ] = $field['ID']; if( !in_array($field['key'], $keys) ) { acf_delete_field( $field['ID'] ); } } acf_enable_local(); } $field_group = acf_update_field_group( $field_group ); $ref[ $field_group['key'] ] = $field_group['ID']; $order[ $field_group['ID'] ] = 0; foreach( $fields as $field ) { if( !$field['ID'] && isset($ref[ $field['key'] ]) ) { $field['ID'] = $ref[ $field['key'] ]; } if( empty($field['parent']) ) { $field['parent'] = $field_group['ID']; } elseif( isset($ref[ $field['parent'] ]) ) { $field['parent'] = $ref[ $field['parent'] ]; } if( !isset($order[ $field['parent'] ]) ) { $order[ $field['parent'] ] = 0; } $field['menu_order'] = $order[ $field['parent'] ]; $order[ $field['parent'] ]++; $field = acf_update_field( $field ); $ref[ $field['key'] ] = $field['ID']; } return $field_group; } ?>

<?php
 if( ! class_exists('acf_admin_update') ) : class acf_admin_update { function __construct() { add_action('admin_menu', array($this,'admin_menu'), 20); add_action('network_admin_menu', array($this,'network_admin_menu'), 20); add_action('wp_ajax_acf/admin/data_upgrade', array($this, 'ajax_upgrade')); } function network_admin_menu() { if( !acf_get_setting('show_admin') ) { return; } $prompt = false; $sites = wp_get_sites(); if( $sites ) { foreach( $sites as $site ) { switch_to_blog( $site['blog_id'] ); $updates = acf_get_updates(); restore_current_blog(); if( $updates ) { $prompt = true; break; } } } if( !$prompt ) { return; } add_action('network_admin_notices', array($this, 'network_admin_notices'), 1); add_submenu_page('update-core.php', __('Upgrade ACF','acf'), __('Upgrade ACF','acf'), acf_get_setting('capability'),'acf-upgrade', array($this,'network_html')); } function network_admin_notices() { if( acf_is_screen('admin_page_acf-upgrade-network') ) { return; } $view = array( 'button_text' => __("Review sites & upgrade", 'acf'), 'button_url' => network_admin_url('update-core.php?page=acf-upgrade'), 'confirm' => false ); acf_get_view('update-notice', $view); } function network_html() { $plugin_version = acf_get_setting('version'); $sites = wp_get_sites(); if( $sites ) { foreach( $sites as $i => $site ) { switch_to_blog( $site['blog_id'] ); $site['name'] = get_bloginfo('name'); $site['url'] = home_url(); $site['updates'] = acf_get_updates(); $site['acf_version'] = get_option('acf_version'); if( !$site['acf_version'] ) { $site['acf_version'] = $plugin_version; } $sites[ $i ] = $site; restore_current_blog(); } } $view = array( 'sites' => $sites, 'plugin_version' => $plugin_version ); acf_enqueue_scripts(); acf_get_view('update-network', $view); } function admin_menu() { $plugin_version = acf_get_setting('version'); $acf_version = get_option('acf_version'); if( !$acf_version ) { update_option('acf_version', $plugin_version ); return; } if( version_compare( $acf_version, $plugin_version, '>=') ) { return; } $updates = acf_get_updates(); if( empty($updates) ) { update_option('acf_version', $plugin_version ); return; } if( !acf_get_setting('show_admin') ) { return; } add_action('admin_notices', array($this, 'admin_notices'), 1); add_submenu_page('edit.php?post_type=acf-field-group', __('Upgrade','acf'), __('Upgrade','acf'), acf_get_setting('capability'),'acf-upgrade', array($this,'html') ); } function admin_notices() { if( acf_is_screen('custom-fields_page_acf-upgrade') ) { return; } $view = array( 'button_text' => __("Upgrade Database", 'acf'), 'button_url' => admin_url('edit.php?post_type=acf-field-group&page=acf-upgrade') ); acf_get_view('update-notice', $view); } function html() { $view = array( 'updates' => acf_get_updates(), 'plugin_version' => acf_get_setting('version') ); acf_enqueue_scripts(); acf_get_view('update', $view); } function ajax_upgrade() { $options = wp_parse_args( $_POST, array( 'nonce' => '', 'blog_id' => '', )); if( !wp_verify_nonce($options['nonce'], 'acf_upgrade') ) { wp_send_json_error(); } if( $options['blog_id'] ) { switch_to_blog( $options['blog_id'] ); } $updates = acf_get_updates(); $message = ''; if( empty($updates) ) { wp_send_json_error(array( 'message' => 'No updates available' )); } foreach( $updates as $version ) { $path = acf_get_path("admin/updates/{$version}.php"); if( !file_exists($path) ) { wp_send_json_error(array( 'message' => 'Error loading update' )); } ob_start(); do_action('acf/upgrade_start/' . $version ); include( $path ); do_action('acf/upgrade_finish/' . $version ); $message .= ob_get_clean(); update_option('acf_version', $version ); } update_option('acf_version', acf_get_setting('version')); wp_send_json_success(array( 'message' => $message )); } } new acf_admin_update(); endif; ?>
